
{% extends "base.html" %}

{% block title %}Admin Dashboard - StealthCAPTCHA{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-shield-alt me-2"></i>Admin Dashboard</h2>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">
                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                </a>
            </div>
        </div>
    </div>
    
    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ stats.total_users }}</h4>
                            <p class="mb-0">Total Users</p>
                        </div>
                        <i class="fas fa-users fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ stats.active_users }}</h4>
                            <p class="mb-0">Active Users</p>
                        </div>
                        <i class="fas fa-user-check fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ stats.suspected_bots }}</h4>
                            <p class="mb-0">Suspected Bots</p>
                        </div>
                        <i class="fas fa-robot fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ stats.blocked_users }}</h4>
                            <p class="mb-0">Blocked Users</p>
                        </div>
                        <i class="fas fa-user-slash fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Charts Row -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h6><i class="fas fa-chart-pie me-2"></i>Detection Overview</h6>
                </div>
                <div class="card-body ">
                    <div style="width: 300px; height:300px; margin:0 auto;">
                        <canvas id="detectionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h6><i class="fas fa-chart-bar me-2"></i>User Behavior Distribution</h6>
                </div>
                <div class="card-body">
                    <canvas id="userBehaviorChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Users Management -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6><i class="fas fa-users-cog me-2"></i>User Management</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Sessions</th>
                                    <th>Bot %</th>
                                    <th>Avg Confidence</th>
                                    <th>Last Login</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                    <tr 
                                        {% if user.is_blocked %}
                                            class="table-danger text-white"
                                        {% elif user.is_likely_bot %}
                                            class="table-warning"
                                        {% endif %}
                                    >
                                    <td>
                                        <strong>{{ user.username }}</strong>

                                        {% if user.is_blocked %}
                                            <i class="fas fa-ban text-danger ms-2" title="Blocked due to bot detection"></i>
                                        {% elif user.is_likely_bot %}
                                            <i class="fas fa-robot text-warning ms-2" title="Suspected Bot"></i>
                                        {% endif %}
                                    </td>
                                    <td>{{ user.email }}</td>
                                    <td>{{ user.total_sessions }}</td>
                                    <td>
                                        <span class="badge bg-{% if user.bot_percentage > 60 %}danger{% elif user.bot_percentage > 30 %}warning{% else %}success{% endif %}">
                                            {{ "%.1f"|format(user.bot_percentage) }}%
                                        </span>
                                    </td>
                                    <td>{{ "%.3f"|format(user.avg_confidence_score) }}</td>
                                    <td>
                                        {% if user.last_login %}
                                        {{ user.last_login.strftime('%m/%d/%Y %H:%M') }}
                                        {% else %}
                                        <span class="text-muted">Never</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if user.is_blocked %}
                                        <span class="badge bg-danger">Blocked</span>
                                        {% else %}
                                        <span class="badge bg-success">Active</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if user.is_blocked %}
                                        <button class="btn btn-sm btn-success" onclick="unblockUser({{ user.id }})">
                                            <i class="fas fa-unlock"></i> Unblock
                                        </button>
                                        {% else %}
                                        <button class="btn btn-sm btn-danger" onclick="blockUser({{ user.id }})">
                                            <i class="fas fa-ban"></i> Block
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        
                        {% if not users %}
                        <div class="text-center py-4">
                            <i class="fas fa-users fa-3x text-muted mb-3"></i>
                            <h5>No users registered yet</h5>
                            <p class="text-muted">Users will appear here after registration.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize charts
const detectionCtx = document.getElementById('detectionChart').getContext('2d');
const userBehaviorCtx = document.getElementById('userBehaviorChart').getContext('2d');

// Detection Overview Chart
new Chart(detectionCtx, {
    type: 'doughnut',
    data: {
        labels: ['Human', 'Bot'],
        datasets: [{
            data: [{{ stats.human_detections }}, {{ stats.bot_detections }}],
            backgroundColor: ['#28a745', '#dc3545'],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// User Behavior Distribution Chart
fetch('/api/admin/users')
    .then(response => response.json())
    .then(data => {
        const botPercentages = data.users.map(u => u.bot_percentage);
        const labels = ['0-20%', '20-40%', '40-60%', '60-80%', '80-100%'];
        const counts = [0, 0, 0, 0, 0];
        
        botPercentages.forEach(percentage => {
            if (percentage < 20) counts[0]++;
            else if (percentage < 40) counts[1]++;
            else if (percentage < 60) counts[2]++;
            else if (percentage < 80) counts[3]++;
            else counts[4]++;
        });
        
        new Chart(userBehaviorCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Number of Users',
                    data: counts,
                    backgroundColor: '#007bff',
                    borderColor: '#0056b3',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    });

// User management functions
async function blockUser(userId) {
    if (!confirm('Are you sure you want to block this user?')) return;
    
    try {
        const response = await fetch(`/admin/block_user/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        if (result.success) {
            location.reload();
        } else {
            alert('Error blocking user: ' + result.message);
        }
    } catch (error) {
        alert('Error blocking user');
    }
}

async function unblockUser(userId) {
    if (!confirm('Are you sure you want to unblock this user?')) return;
    
    try {
        const response = await fetch(`/admin/unblock_user/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        if (result.success) {
            location.reload();
        } else {
            alert('Error unblocking user: ' + result.message);
        }
    } catch (error) {
        alert('Error unblocking user');
    }
}
</script>
{% endblock %}
